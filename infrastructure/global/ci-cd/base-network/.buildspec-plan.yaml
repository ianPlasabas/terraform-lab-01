version: 0.2

env:
  variables:
    TF_WORKING_DIR: "infrastructure/env/dev/base-network"

phases:
  install:
    commands:
      - echo "Installing Terraform"
      - wget https://releases.hashicorp.com/terraform/1.13.4/terraform_1.13.4_linux_amd64.zip -O /tmp/terraform.zip
      - unzip -o /tmp/terraform.zip -d /usr/local/bin
      - terraform --version


  pre_build:
    commands: 
      - unset AWS_PROFILE || true
      - unset AWS_DEFAULT_PROFILE || true
      - export AWS_DEFAULT_REGION=ap-southeast-1
      - echo "Changing directory to $TF_WORKING_DIR"
      - cd $TF_WORKING_DIR
      - pwd
      - ls -la
      - terraform init -input=false -reconfigure
      - echo "Running Terraform plan"
      - terraform plan -input=false -out=tfplan.binary
      - terraform show -no-color -json tfplan.binary > tfplan.json

artifacts:
  files:
    - infrastructure/env/dev/base-network/tfplan.binary
    - infrastructure/env/dev/base-network/tfplan.json
  discard-paths: no
